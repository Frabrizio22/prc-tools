<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Checkout - PRC Peptides</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #FFFFFF;
            color: #0A1628;
            line-height: 1.6;
            padding-bottom: 120px;
            -webkit-font-smoothing: antialiased;
        }

        .header {
            background: #0A1628;
            color: #FFFFFF;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .back-link {
            color: #06B6D4;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .age-gate {
            background: #0A1628;
            color: #FFFFFF;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .age-gate-content {
            background: #FFFFFF;
            color: #0A1628;
            padding: 40px 30px;
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
        }

        .age-gate-content h2 {
            font-size: 24px;
            margin-bottom: 16px;
            color: #0A1628;
        }

        .age-gate-content p {
            margin-bottom: 24px;
            font-size: 15px;
            line-height: 1.6;
            color: #475569;
        }

        .age-gate-buttons {
            display: flex;
            gap: 12px;
        }

        .age-gate-button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .age-gate-button.confirm {
            background: #2B7DE9;
            color: #FFFFFF;
        }

        .age-gate-button.confirm:active {
            transform: scale(0.98);
            background: #1e5fb8;
        }

        .age-gate-button.deny {
            background: #f1f5f9;
            color: #475569;
        }

        .section {
            background: #FFFFFF;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #0A1628;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-number {
            background: #2B7DE9;
            color: #FFFFFF;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #334155;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
            color: #0A1628;
            background: #FFFFFF;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2B7DE9;
            box-shadow: 0 0 0 3px rgba(43, 125, 233, 0.1);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #e2e8f0;
            gap: 12px;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex: 1;
            min-width: 0;
        }

        .cart-item-name {
            font-weight: 600;
            font-size: 15px;
            color: #0A1628;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cart-item-price {
            font-size: 14px;
            color: #64748b;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .qty-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #FFFFFF;
            color: #0A1628;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .qty-btn:active {
            transform: scale(0.95);
        }

        .qty-display {
            min-width: 24px;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
        }

        .remove-btn {
            color: #94A3B8;
            font-size: 20px;
            text-decoration: none;
            font-weight: 400;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
            padding: 4px;
        }

        .remove-btn:hover {
            color: #64748B;
        }

        .payment-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .payment-option:active {
            transform: scale(0.99);
        }

        .payment-option.selected {
            border-color: #2B7DE9;
            background: rgba(43, 125, 233, 0.05);
        }

        .payment-radio {
            margin-top: 2px;
        }

        .payment-info {
            flex: 1;
        }

        .payment-name {
            font-weight: 700;
            font-size: 16px;
            color: #0A1628;
            margin-bottom: 4px;
        }

        .payment-desc {
            font-size: 13px;
            color: #64748b;
            line-height: 1.4;
        }

        .payment-badge {
            display: inline-block;
            background: #10b981;
            color: #FFFFFF;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 6px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 15px;
        }

        .summary-row.total {
            border-top: 2px solid #e2e8f0;
            margin-top: 8px;
            padding-top: 16px;
            font-size: 18px;
            font-weight: 700;
            color: #0A1628;
        }

        .summary-row.discount {
            color: #10b981;
            font-weight: 600;
        }

        .shipping-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .shipping-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .shipping-option.selected {
            border-color: #2B7DE9;
            background: rgba(43, 125, 233, 0.05);
        }

        .shipping-info {
            flex: 1;
        }

        .shipping-name {
            font-weight: 700;
            font-size: 15px;
            color: #0A1628;
        }

        .shipping-time {
            font-size: 13px;
            color: #64748b;
        }

        .shipping-price {
            font-weight: 700;
            font-size: 16px;
            color: #0A1628;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #2B7DE9;
            color: #FFFFFF;
        }

        .btn-primary:active {
            transform: scale(0.98);
            background: #1e5fb8;
        }

        .btn-primary:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .disclaimer {
            background: none;
            border: none;
            border-radius: 0;
            padding: 8px 16px;
            margin-bottom: 16px;
            font-size: 12px;
            color: #94A3B8;
            text-align: center;
            letter-spacing: 0.2px;
        }

        .empty-cart {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-cart-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-cart-text {
            font-size: 18px;
            color: #64748b;
            margin-bottom: 24px;
        }

        .order-success {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .order-number {
            font-size: 24px;
            font-weight: 700;
            color: #0A1628;
            margin-bottom: 8px;
        }

        .order-status {
            font-size: 16px;
            color: #64748b;
            margin-bottom: 32px;
        }

        .payment-instructions {
            background: #f8fafc;
            border: 2px solid #2B7DE9;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
            text-align: left;
        }

        .payment-instructions h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #0A1628;
        }

        .instruction-step {
            margin-bottom: 12px;
            font-size: 15px;
            line-height: 1.6;
        }

        .highlight {
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }

        .warning {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-size: 13px;
            color: #991b1b;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #FFFFFF;
            border-top: 1px solid #e2e8f0;
            padding: 16px 20px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }

        .footer-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .hidden {
            display: none;
        }

        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }

            .footer {
                position: static;
                box-shadow: none;
                border-top: none;
                padding: 0;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Age Gate -->
    <div id="ageGate" class="age-gate">
        <div class="age-gate-content">
            <h2>Age Verification</h2>
            <p>You must be 18 years or older to purchase research peptides. These products are for research purposes only.</p>
            <div class="age-gate-buttons">
                <button class="age-gate-button deny" onclick="denyAge()">Under 18</button>
                <button class="age-gate-button confirm" onclick="confirmAge()">I'm 18+</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">PRC Peptides</div>
            <a href="shop.html" class="back-link">‚Üê Back to Shop</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="disclaimer">
            All products are for laboratory research purposes only. Not for human consumption.
        </div>

        <!-- Step 1: Cart -->
        <div id="cartSection" class="section">
            <div class="section-title">
                <span class="step-number">1</span>
                Your Cart
            </div>
            <div id="cartItems"></div>
        </div>

        <!-- Step 2: Customer Info -->
        <div id="customerSection" class="section hidden">
            <div class="section-title">
                <span class="step-number">2</span>
                Customer Information
            </div>
            <form id="customerForm">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" id="fullName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-input" id="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Street Address *</label>
                    <input type="text" class="form-input" id="address" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">City *</label>
                        <input type="text" class="form-input" id="city" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">State *</label>
                        <input type="text" class="form-input" id="state" maxlength="2" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ZIP Code *</label>
                        <input type="text" class="form-input" id="zip" maxlength="10" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="phone">
                    </div>
                </div>
            </form>
        </div>

        <!-- Step 3: Shipping -->
        <div id="shippingSection" class="section hidden">
            <div class="section-title">
                <span class="step-number">3</span>
                Shipping Method
            </div>
            <div class="shipping-options">
                <div class="shipping-option selected" onclick="selectShipping(this, 'standard', 9.99)">
                    <input type="radio" name="shipping" class="payment-radio" checked>
                    <div class="shipping-info">
                        <div class="shipping-name">Standard Shipping</div>
                        <div class="shipping-time">3-5 business days</div>
                    </div>
                    <div class="shipping-price">$9.99</div>
                </div>
                <div class="shipping-option" onclick="selectShipping(this, 'expedited', 19.99)">
                    <input type="radio" name="shipping">
                    <div class="shipping-info">
                        <div class="shipping-name">Expedited Shipping</div>
                        <div class="shipping-time">1-2 business days</div>
                    </div>
                    <div class="shipping-price">$19.99</div>
                </div>
            </div>
        </div>

        <!-- Step 4: Payment Method -->
        <div id="paymentSection" class="section hidden">
            <div class="section-title">
                <span class="step-number">4</span>
                Payment Method
            </div>
            <div class="payment-option" onclick="selectPayment(this, 'crypto')">
                <input type="radio" name="payment" class="payment-radio">
                <div class="payment-info">
                    <div class="payment-name">Pay with Crypto</div>
                    <div class="payment-desc">Bitcoin, Ethereum, USDC & more via Coinbase Commerce</div>
                </div>
            </div>
            <div class="payment-option" onclick="selectPayment(this, 'zelle')">
                <input type="radio" name="payment" class="payment-radio">
                <div class="payment-info">
                    <div class="payment-name">Pay with Zelle</div>
                    <div class="payment-desc">Instant bank transfer ‚Äî easy and secure</div>
                    <span class="payment-badge">5% DISCOUNT</span>
                </div>
            </div>
            <div class="payment-option" onclick="selectPayment(this, 'cashapp')">
                <input type="radio" name="payment" class="payment-radio">
                <div class="payment-info">
                    <div class="payment-name">Pay with Cash App</div>
                    <div class="payment-desc">Send payment directly via Cash App</div>
                    <span class="payment-badge">5% DISCOUNT</span>
                </div>
            </div>
        </div>

        <!-- Promo Code -->
        <div id="promoSection" class="section hidden">
            <div class="section-title">Promo Code</div>
            <div style="display:flex;gap:8px">
                <input type="text" class="form-input" id="promoInput" placeholder="Enter code" style="flex:1;text-transform:uppercase">
                <button class="btn btn-primary" onclick="applyPromo()" style="width:auto;padding:12px 20px;font-size:14px">Apply</button>
            </div>
            <div id="promoMsg" style="font-size:13px;margin-top:6px"></div>
        </div>

        <!-- Step 5: Order Summary -->
        <div id="summarySection" class="section hidden">
            <div class="section-title">
                <span class="step-number">5</span>
                Order Summary
            </div>
            <div id="orderSummary"></div>
        </div>

        <!-- Order Confirmation -->
        <div id="confirmationSection" class="hidden">
            <div class="order-success">
                <div class="success-icon">‚úì</div>
                <div class="order-number" id="orderNumber"></div>
                <div class="order-status">Order Placed Successfully</div>
            </div>

            <div id="paymentInstructions"></div>

            <div class="section">
                <div class="section-title">Order Details</div>
                <div id="orderDetails"></div>
            </div>

            <button class="btn btn-primary" onclick="emailOrder()">Email Order Details</button>
            <br><br>
            <a href="shop.html" class="btn btn-secondary">Continue Shopping</a>
        </div>
    </div>

    <!-- Footer with Action Button -->
    <div id="footer" class="footer">
        <div class="footer-content">
            <button id="actionBtn" class="btn btn-primary" onclick="nextStep()">Continue to Customer Info</button>
        </div>
    </div>

    <script>
        // ES5 compatible code only
        var cart = [];
        var savedOrder = null; // Preserved after cart clears
        var currentStep = 1;
        var selectedShipping = { name: 'Standard Shipping', price: 9.99 };
        var selectedPayment = null;
        var orderNumber = '';
        var customerInfo = {};

        // Check age gate
        function checkAgeGate() {
            var ageConfirmed = sessionStorage.getItem('ageConfirmed');
            if (ageConfirmed === 'true') {
                document.getElementById('ageGate').style.display = 'none';
                initCheckout();
            }
        }

        function confirmAge() {
            sessionStorage.setItem('ageConfirmed', 'true');
            document.getElementById('ageGate').style.display = 'none';
            initCheckout();
        }

        function denyAge() {
            window.location.href = 'https://www.google.com';
        }

        // Initialize checkout
        function initCheckout() {
            loadCart();
            renderCart();
            updateSummary();
        }

        // Parse URL params (ES5 compatible)
        function getUrlParam(name) {
            var search = window.location.search.substring(1);
            var pairs = search.split('&');
            for (var i = 0; i < pairs.length; i++) {
                var pair = pairs[i].split('=');
                if (decodeURIComponent(pair[0]) === name) {
                    return decodeURIComponent(pair[1] || '');
                }
            }
            return null;
        }

        // Load cart from URL params or sessionStorage
        function loadCart() {
            var product = getUrlParam('product');
            var price = getUrlParam('price');

            // Always load existing cart first
            var saved = sessionStorage.getItem('prcCart');
            if (saved) {
                cart = JSON.parse(saved);
            }

            if (product && price) {
                // Check if product already in cart
                var found = false;
                var decodedName = decodeURIComponent(product);
                for (var i = 0; i < cart.length; i++) {
                    if (cart[i].name === decodedName) {
                        cart[i].quantity += 1;
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    cart.push({
                        name: decodedName,
                        price: parseFloat(price),
                        quantity: 1
                    });
                }
                saveCart();
                // Clear URL params so refresh doesn't re-add
                if (window.history && window.history.replaceState) {
                    window.history.replaceState({}, '', 'checkout.html');
                }
            }
        }

        function saveCart() {
            sessionStorage.setItem('prcCart', JSON.stringify(cart));
        }

        function renderCart() {
            var container = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                container.innerHTML = '<div class="empty-cart"><div class="empty-cart-icon">üõí</div><div class="empty-cart-text">Your cart is empty</div><a href="shop.html" class="btn btn-primary">Browse Products</a></div>';
                document.getElementById('footer').style.display = 'none';
                return;
            }

            var html = '';
            for (var i = 0; i < cart.length; i++) {
                var item = cart[i];
                html += '<div class="cart-item">';
                html += '<div class="cart-item-info">';
                html += '<div class="cart-item-name">' + item.name + '</div>';
                html += '<div class="cart-item-price">$' + item.price.toFixed(2) + ' each</div>';
                html += '</div>';
                html += '<div class="cart-item-actions">';
                html += '<div class="qty-control">';
                html += '<button class="qty-btn" onclick="updateQty(' + i + ', -1)">-</button>';
                html += '<span class="qty-display">' + item.quantity + '</span>';
                html += '<button class="qty-btn" onclick="updateQty(' + i + ', 1)">+</button>';
                html += '</div>';
                html += '<a class="remove-btn" onclick="removeItem(' + i + ')" title="Remove">√ó</a>';
                html += '</div>';
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function updateQty(index, change) {
            cart[index].quantity += change;
            if (cart[index].quantity < 1) {
                cart[index].quantity = 1;
            }
            saveCart();
            renderCart();
            updateSummary();
        }

        function removeItem(index) {
            cart.splice(index, 1);
            saveCart();
            renderCart();
            updateSummary();
        }

        function getSubtotal() {
            var total = 0;
            for (var i = 0; i < cart.length; i++) {
                total += cart[i].price * cart[i].quantity;
            }
            return total;
        }

        var promoApplied = false;

        function applyPromo() {
            var code = document.getElementById('promoInput');
            var msg = document.getElementById('promoMsg');
            if (!code || !msg) return;
            if (code.value.trim().toUpperCase() === 'RESEARCH') {
                promoApplied = true;
                msg.textContent = '‚úì Code RESEARCH applied ‚Äî 5% off!';
                msg.style.color = '#059669';
                code.disabled = true;
                updateSummary();
            } else {
                msg.textContent = 'Invalid code';
                msg.style.color = '#ef4444';
            }
        }

        function getDiscount() {
            if (selectedPayment === 'zelle' || selectedPayment === 'cashapp') {
                return getSubtotal() * 0.05;
            }
            if (promoApplied) {
                return getSubtotal() * 0.05;
            }
            return 0;
        }

        function getShipping() {
            var subtotal = getSubtotal();
            if (subtotal >= 150) {
                return 0;
            }
            return selectedShipping.price;
        }

        function getTotal() {
            return getSubtotal() - getDiscount() + getShipping();
        }

        function updateSummary() {
            var html = '';
            html += '<div class="summary-row"><span>Subtotal</span><span>$' + getSubtotal().toFixed(2) + '</span></div>';
            
            if (getDiscount() > 0) {
                var discLabel = promoApplied ? 'Promo RESEARCH (5%)' : 'Discount (5%)';
                html += '<div class="summary-row discount"><span>' + discLabel + '</span><span>-$' + getDiscount().toFixed(2) + '</span></div>';
            }
            
            html += '<div class="summary-row"><span>' + selectedShipping.name + '</span><span>';
            if (getShipping() === 0) {
                html += 'FREE';
            } else {
                html += '$' + getShipping().toFixed(2);
            }
            html += '</span></div>';
            
            html += '<div class="summary-row total"><span>Total</span><span>$' + getTotal().toFixed(2) + '</span></div>';
            
            document.getElementById('orderSummary').innerHTML = html;
        }

        function selectShipping(el, type, price) {
            selectedShipping = {
                name: type === 'standard' ? 'Standard Shipping' : 'Expedited Shipping',
                price: price
            };
            
            var options = document.querySelectorAll('.shipping-option');
            for (var i = 0; i < options.length; i++) {
                options[i].classList.remove('selected');
                options[i].querySelector('input[type="radio"]').checked = false;
            }
            el.classList.add('selected');
            el.querySelector('input[type="radio"]').checked = true;
            
            updateSummary();
        }

        function selectPayment(el, method) {
            selectedPayment = method;
            
            var options = document.querySelectorAll('.payment-option');
            for (var i = 0; i < options.length; i++) {
                options[i].classList.remove('selected');
                options[i].querySelector('input[type="radio"]').checked = false;
            }
            el.classList.add('selected');
            el.querySelector('input[type="radio"]').checked = true;
            
            updateSummary();
        }

        function nextStep() {
            if (currentStep === 1) {
                // Cart to Customer Info
                if (cart.length === 0) return;
                document.getElementById('customerSection').classList.remove('hidden');
                document.getElementById('actionBtn').textContent = 'Continue to Shipping';
                currentStep = 2;
            } else if (currentStep === 2) {
                // Validate customer info
                var form = document.getElementById('customerForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                customerInfo = {
                    name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value.toUpperCase(),
                    zip: document.getElementById('zip').value,
                    phone: document.getElementById('phone').value
                };
                
                document.getElementById('shippingSection').classList.remove('hidden');
                document.getElementById('actionBtn').textContent = 'Continue to Payment';
                currentStep = 3;
            } else if (currentStep === 3) {
                // Shipping to Payment
                document.getElementById('paymentSection').classList.remove('hidden');
                document.getElementById('promoSection').classList.remove('hidden');
                document.getElementById('summarySection').classList.remove('hidden');
                updateSummary();
                document.getElementById('actionBtn').textContent = 'Place Order';
                currentStep = 4;
            } else if (currentStep === 4) {
                // Place order
                if (!selectedPayment) {
                    alert('Please select a payment method');
                    return;
                }
                placeOrder();
            }
            
            window.scrollTo(0, 0);
        }

        function generateOrderNumber() {
            var num = Math.floor(10000 + Math.random() * 90000);
            return 'PRC-' + num;
        }

        function placeOrder() {
            orderNumber = generateOrderNumber();
            
            // Save order data BEFORE clearing cart
            savedOrder = {
                items: [],
                subtotal: getSubtotal(),
                discount: getDiscount(),
                shipping: getShipping(),
                shippingName: selectedShipping.name,
                total: getTotal(),
                payment: selectedPayment,
                customer: customerInfo
            };
            for (var i = 0; i < cart.length; i++) {
                savedOrder.items.push({
                    name: cart[i].name,
                    price: cart[i].price,
                    quantity: cart[i].quantity
                });
            }
            
            // Hide checkout sections
            document.getElementById('cartSection').classList.add('hidden');
            document.getElementById('customerSection').classList.add('hidden');
            document.getElementById('shippingSection').classList.add('hidden');
            document.getElementById('paymentSection').classList.add('hidden');
            document.getElementById('promoSection').classList.add('hidden');
            document.getElementById('summarySection').classList.add('hidden');
            document.getElementById('footer').classList.add('hidden');
            
            // Show confirmation
            document.getElementById('confirmationSection').classList.remove('hidden');
            document.getElementById('orderNumber').textContent = 'Order ' + orderNumber;
            
            // Render payment instructions
            renderPaymentInstructions();
            
            // Render order details
            renderOrderDetails();
            
            // Clear cart
            cart = [];
            saveCart();
        }

        function renderPaymentInstructions() {
            var container = document.getElementById('paymentInstructions');
            var html = '<div class="payment-instructions">';
            var total = savedOrder.total.toFixed(2);
            
            if (selectedPayment === 'crypto') {
                html += '<h3>üí∞ Payment Instructions - Cryptocurrency</h3>';
                html += '<div class="instruction-step">We will email you a secure Coinbase Commerce payment link within <span class="highlight">15 minutes</span>.</div>';
                html += '<div class="instruction-step">Check your inbox at <strong>' + savedOrder.customer.email + '</strong></div>';
                html += '<div class="instruction-step">The link will allow you to pay with Bitcoin, Ethereum, USDC, and other cryptocurrencies.</div>';
                html += '<div class="instruction-step">Your order will ship once payment is confirmed.</div>';
            } else if (selectedPayment === 'zelle') {
                html += '<h3>üí∞ Payment Instructions - Zelle</h3>';
                html += '<div class="instruction-step"><strong>1.</strong> Open your Zelle app or banking app</div>';
                html += '<div class="instruction-step"><strong>2.</strong> Send <span class="highlight">$' + total + '</span> to <span class="highlight">support@prcpeptides.com</span></div>';
                html += '<div class="instruction-step"><strong>3.</strong> In the memo/note field, include: <span class="highlight">' + orderNumber + '</span></div>';
                html += '<div class="warning">‚ö†Ô∏è IMPORTANT: Do NOT mention peptides, product names, or research purposes in the payment memo. Only include the order number.</div>';
            } else if (selectedPayment === 'cashapp') {
                html += '<h3>üí∞ Payment Instructions - Cash App</h3>';
                html += '<div class="instruction-step"><strong>1.</strong> Open your Cash App</div>';
                html += '<div class="instruction-step"><strong>2.</strong> Send <span class="highlight">$' + total + '</span> to <span class="highlight">$PRCPeptides</span></div>';
                html += '<div class="instruction-step"><strong>3.</strong> In the note field, include: <span class="highlight">' + orderNumber + '</span></div>';
                html += '<div class="warning">‚ö†Ô∏è IMPORTANT: Do NOT mention peptides, product names, or research purposes in the payment note. Only include the order number.</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderOrderDetails() {
            var o = savedOrder;
            var html = '';
            
            // Items
            for (var i = 0; i < o.items.length; i++) {
                var item = o.items[i];
                html += '<div class="summary-row">';
                html += '<span>' + item.name + ' x' + item.quantity + '</span>';
                html += '<span>$' + (item.price * item.quantity).toFixed(2) + '</span>';
                html += '</div>';
            }
            
            // Summary
            html += '<div class="summary-row"><span>Subtotal</span><span>$' + o.subtotal.toFixed(2) + '</span></div>';
            
            if (o.discount > 0) {
                html += '<div class="summary-row discount"><span>Discount (5%)</span><span>-$' + o.discount.toFixed(2) + '</span></div>';
            }
            
            html += '<div class="summary-row"><span>' + o.shippingName + '</span><span>';
            if (o.shipping === 0) {
                html += 'FREE';
            } else {
                html += '$' + o.shipping.toFixed(2);
            }
            html += '</span></div>';
            
            html += '<div class="summary-row total"><span>Total</span><span>$' + o.total.toFixed(2) + '</span></div>';
            
            html += '<hr style="margin: 16px 0; border: none; border-top: 1px solid #e2e8f0;">';
            
            // Shipping address
            html += '<div style="margin-top: 16px;">';
            html += '<div style="font-weight: 700; margin-bottom: 8px;">Shipping Address</div>';
            html += '<div style="font-size: 14px; color: #64748b; line-height: 1.6;">';
            html += o.customer.name + '<br>';
            html += o.customer.address + '<br>';
            html += o.customer.city + ', ' + o.customer.state + ' ' + o.customer.zip + '<br>';
            if (o.customer.phone) {
                html += o.customer.phone + '<br>';
            }
            html += o.customer.email;
            html += '</div></div>';
            
            document.getElementById('orderDetails').innerHTML = html;
        }

        function emailOrder() {
            var o = savedOrder;
            var subject = 'Order ' + orderNumber + ' - Payment Confirmation';
            var body = 'Hello PRC Peptides,\n\n';
            body += 'I have just placed order ' + orderNumber + ' and ';
            
            if (o.payment === 'crypto') {
                body += 'I am ready to pay with cryptocurrency. Please send me the Coinbase Commerce payment link.\n\n';
            } else if (o.payment === 'zelle') {
                body += 'I have sent payment via Zelle.\n\n';
            } else if (o.payment === 'cashapp') {
                body += 'I have sent payment via Cash App.\n\n';
            }
            
            body += 'Order Details:\n';
            for (var i = 0; i < o.items.length; i++) {
                var item = o.items[i];
                body += '- ' + item.name + ' x' + item.quantity + ' ($' + (item.price * item.quantity).toFixed(2) + ')\n';
            }
            body += '\n';
            body += 'Subtotal: $' + o.subtotal.toFixed(2) + '\n';
            if (o.discount > 0) {
                body += 'Discount: -$' + o.discount.toFixed(2) + '\n';
            }
            body += 'Shipping: $' + o.shipping.toFixed(2) + '\n';
            body += 'Total: $' + o.total.toFixed(2) + '\n\n';
            
            body += 'Shipping Address:\n';
            body += o.customer.name + '\n';
            body += o.customer.address + '\n';
            body += o.customer.city + ', ' + o.customer.state + ' ' + o.customer.zip + '\n';
            if (o.customer.phone) {
                body += o.customer.phone + '\n';
            }
            body += o.customer.email + '\n\n';
            
            body += 'Thank you!';
            
            var mailtoLink = 'mailto:support@prcpeptides.com?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
            window.location.href = mailtoLink;
        }

        // Initialize on load
        checkAgeGate();
    </script>
</body>
</html>